<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–í—Ö–æ–¥ ‚Äî –ê–¥–≤–æ–∫–∞—Ç –ö–†</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Mulish:wght@400;700&display=swap" rel="stylesheet">
<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Mulish',sans-serif;background:linear-gradient(135deg,#0a0e27 0%,#1a1f3a 100%);color:#e2e8f0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.container{max-width:450px;width:100%}
.logo{width:100px;height:100px;margin:0 auto 24px;background:linear-gradient(135deg,#f59e0b,#d97706);border-radius:25px;display:flex;align-items:center;justify-content:center;font-size:48px;box-shadow:0 10px 40px rgba(245,158,11,0.3)}
h1{font-family:'Playfair Display',serif;font-size:2rem;color:#f59e0b;margin-bottom:8px;text-align:center}
.subtitle{text-align:center;color:#94a3b8;margin-bottom:40px;font-size:0.9rem}
.card{background:rgba(26,31,58,0.8);border:1px solid rgba(148,163,184,0.2);border-radius:20px;padding:40px;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
.form-group{margin-bottom:24px}
label{display:block;color:#cbd5e1;margin-bottom:8px;font-weight:600;font-size:0.9rem}
input{width:100%;padding:14px 16px;background:rgba(15,23,42,0.6);border:2px solid rgba(148,163,184,0.2);border-radius:12px;color:#e2e8f0;font-size:1rem;transition:all 0.2s;font-family:'Mulish',sans-serif}
input:focus{outline:none;border-color:#3b82f6;background:rgba(15,23,42,0.8)}
input::placeholder{color:#64748b}
.btn{width:100%;padding:16px;background:linear-gradient(135deg,#3b82f6,#2563eb);border:none;border-radius:12px;color:white;font-weight:700;font-size:1.1rem;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 20px rgba(59,130,246,0.4);margin-top:8px}
.btn:hover{transform:translateY(-2px);box-shadow:0 6px 30px rgba(59,130,246,0.5)}
.btn:active{transform:translateY(0)}
.btn:disabled{opacity:0.6;cursor:not-allowed}
.btn-secondary{background:transparent;border:2px solid rgba(148,163,184,0.3);color:#cbd5e1;box-shadow:none;margin-top:12px}
.btn-secondary:hover{border-color:#3b82f6;background:rgba(59,130,246,0.1);box-shadow:none}
.error{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);padding:12px 16px;border-radius:8px;color:#fca5a5;font-size:0.9rem;margin-bottom:20px;display:none}
.error.show{display:block}
.success{background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);padding:12px 16px;border-radius:8px;color:#6ee7b7;font-size:0.9rem;margin-bottom:20px;display:none}
.success.show{display:block}
.info{background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);padding:12px 16px;border-radius:8px;color:#60a5fa;font-size:0.9rem;margin-bottom:20px;display:none}
.info.show{display:block}
.divider{text-align:center;color:#64748b;margin:24px 0;position:relative}
.divider:before,.divider:after{content:'';position:absolute;top:50%;width:40%;height:1px;background:rgba(148,163,184,0.2)}
.divider:before{left:0}
.divider:after{right:0}
.links{text-align:center;margin-top:24px;font-size:0.9rem}
.links a{color:#3b82f6;text-decoration:none;font-weight:600}
.links a:hover{text-decoration:underline}
.loading{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(10,14,39,0.9);display:none;align-items:center;justify-content:center;z-index:1000;flex-direction:column;gap:16px}
.loading.show{display:flex}
.spinner{width:50px;height:50px;border:4px solid rgba(59,130,246,0.3);border-top-color:#3b82f6;border-radius:50%;animation:spin 1s linear infinite}
.loading-text{color:#60a5fa;font-size:0.9rem}
@keyframes spin{to{transform:rotate(360deg)}}
.hidden{display:none}
@media(max-width:768px){
.card{padding:30px 24px}
h1{font-size:1.75rem}
}
</style>
</head>
<body>

<div class="loading" id="loading">
<div class="spinner"></div>
<div class="loading-text" id="loadingText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div class="container">
<div class="logo">‚öñÔ∏è</div>
<h1>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h1>
<p class="subtitle">–ê–¥–≤–æ–∫–∞—Ç –ö–† ‚Äî –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —ç–∫–∑–∞–º–µ–Ω—É</p>

<div class="card">
<div class="error" id="error"></div>
<div class="success" id="success"></div>
<div class="info" id="info"></div>

<!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å -->
<form onsubmit="handleLogin(event)" id="loginForm">
<div class="form-group">
<label for="username">üë§ –õ–æ–≥–∏–Ω</label>
<input type="text" id="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ª–æ–≥–∏–Ω" required autocomplete="username">
</div>

<div class="form-group">
<label for="password">üîí –ü–∞—Ä–æ–ª—å</label>
<input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å" required autocomplete="current-password">
</div>

<button type="submit" class="btn" id="loginBtn">üöÄ –í–æ–π—Ç–∏</button>
</form>

<!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ email (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
<form onsubmit="handleEmailSubmit(event)" id="emailForm" class="hidden">
<div class="form-group">
<label for="email">üìß –í–∞—à Email</label>
<input type="email" id="email" placeholder="example@mail.com" required>
<small style="color:#94a3b8;font-size:0.85rem;display:block;margin-top:8px">
–î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–∏–≤—è–∂–∏—Ç–µ –≤–∞—à email –∫ –∞–∫–∫–∞—É–Ω—Ç—É
</small>
</div>
<button type="submit" class="btn">üìß –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
<button type="button" class="btn btn-secondary" onclick="cancelEmail()">‚Üê –ù–∞–∑–∞–¥</button>
</form>

<!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ –∫–æ–¥–∞ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
<form onsubmit="handleCodeSubmit(event)" id="codeForm" class="hidden">
<div class="form-group">
<label for="code">üîë –ö–æ–¥ –∏–∑ email</label>
<input type="text" id="code" placeholder="123456" required maxlength="6" pattern="[0-9]{6}">
<small style="color:#94a3b8;font-size:0.85rem;display:block;margin-top:8px">
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É "–°–ø–∞–º" –µ—Å–ª–∏ –Ω–µ –ø—Ä–∏—à–ª–æ
</small>
</div>
<button type="submit" class="btn">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
<button type="button" class="btn btn-secondary" onclick="resendCode()">üîÑ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–Ω–æ–≤–∞</button>
</form>

<div class="divider">–∏–ª–∏</div>

<button class="btn btn-secondary" onclick="tryDemo()">üéì –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥–µ–º–æ-–≤–µ—Ä—Å–∏—é</button>

<div class="links">
<a href="index.html">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
</div>
</div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyBQD4IERaH6lW-TKs03giyUy9IL2UbT5OQ",
  authDomain: "advokat-kg.firebaseapp.com",
  projectId: "advokat-kg",
  storageBucket: "advokat-kg.firebasestorage.app",
  messagingSenderId: "13056866047",
  appId: "1:13056866047:web:6ac7b7a7eb4f3c5326beca"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// EmailJS Configuration
emailjs.init("4o9oaqcXweWG-g78O"); // Public Key

const EMAILJS_SERVICE_ID = "service_lbv5xmw";
const EMAILJS_TEMPLATE_ID = "template_ty9d2o5";

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentUsername = '';
let currentUserData = null;
let generatedCode = '';
let codeExpiry = 0;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∞
async function initializeAdmin(){
try{
const adminDoc = await db.collection('users').doc('admin').get();
if(!adminDoc.exists){
await db.collection('users').doc('admin').set({
password: 'admin2024',
role: 'admin',
name: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
created: new Date().toISOString()
});
}
}catch(e){
console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', e);
}
}

initializeAdmin();

function showLoading(show, text = '–ó–∞–≥—Ä—É–∑–∫–∞...'){
document.getElementById('loading').classList.toggle('show', show);
document.getElementById('loadingText').textContent = text;
document.getElementById('loginBtn').disabled = show;
}

function showError(msg){
const el = document.getElementById('error');
el.textContent = msg;
el.classList.add('show');
document.getElementById('success').classList.remove('show');
document.getElementById('info').classList.remove('show');
setTimeout(() => el.classList.remove('show'), 5000);
}

function showSuccess(msg){
const el = document.getElementById('success');
el.textContent = msg;
el.classList.add('show');
document.getElementById('error').classList.remove('show');
document.getElementById('info').classList.remove('show');
}

function showInfo(msg){
const el = document.getElementById('info');
el.textContent = msg;
el.classList.add('show');
document.getElementById('error').classList.remove('show');
document.getElementById('success').classList.remove('show');
}

function showForm(formId){
['loginForm','emailForm','codeForm'].forEach(id => {
document.getElementById(id).classList.add('hidden');
});
document.getElementById(formId).classList.remove('hidden');
}

function tryDemo(){
sessionStorage.setItem('user', 'demo');
db.collection('logs').add({
username: 'demo',
event: 'login_success',
details: '–î–µ–º–æ-–¥–æ—Å—Ç—É–ø',
timestamp: new Date().toISOString(),
userAgent: navigator.userAgent
}).catch(e => console.error('–õ–æ–≥ –æ—à–∏–±–∫–∞:', e));
window.location.href = 'app-with-demo.html';
}

async function handleLogin(event){
event.preventDefault();
const username = document.getElementById('username').value.trim();
const password = document.getElementById('password').value;

if(username === 'demo'){
tryDemo();
return;
}

showLoading(true);

try {
const userDoc = await db.collection('users').doc(username).get();

if(!userDoc.exists){
showError('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
await db.collection('logs').add({
username,
event: 'login_failed',
details: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω',
timestamp: new Date().toISOString(),
userAgent: navigator.userAgent
});
showLoading(false);
return;
}

const user = userDoc.data();

if(user.password !== password){
showError('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
await db.collection('logs').add({
username,
event: 'login_failed',
details: '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å',
timestamp: new Date().toISOString(),
userAgent: navigator.userAgent
});
showLoading(false);
return;
}

currentUsername = username;
currentUserData = user;

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π email
if(!user.email){
// –ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥ - –Ω—É–∂–Ω–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å email
showInfo('üìß –î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–∏–≤—è–∂–∏—Ç–µ email –∫ –∞–∫–∫–∞—É–Ω—Ç—É');
showForm('emailForm');
showLoading(false);
} else {
// Email —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω - –ø—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
const deviceFingerprint = getDeviceFingerprint();
if(user.devices && user.devices.includes(deviceFingerprint)){
// –ó–Ω–∞–∫–æ–º–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ - –≤—Ö–æ–¥–∏–º —Å—Ä–∞–∑—É
await completeLogin();
} else {
// –ù–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ - —Ç—Ä–µ–±—É–µ–º –∫–æ–¥
showInfo('üîê –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ. –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ ' + maskEmail(user.email));
await sendVerificationCode(user.email);
showForm('codeForm');
showLoading(false);
}
}

} catch(error) {
console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
showError('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
showLoading(false);
}
}

async function handleEmailSubmit(event){
event.preventDefault();
const email = document.getElementById('email').value.trim();

showLoading(true, '–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞...');

try {
await sendVerificationCode(email);
currentUserData.email = email; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ
showInfo('üìß –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ ' + email);
showForm('codeForm');
} catch(error) {
showError('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞');
}

showLoading(false);
}

async function sendVerificationCode(email){
// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥
generatedCode = Math.floor(100000 + Math.random() * 900000).toString();
codeExpiry = Date.now() + 10 * 60 * 1000; // 10 –º–∏–Ω—É—Ç

try {
await emailjs.send(
EMAILJS_SERVICE_ID,
EMAILJS_TEMPLATE_ID,
{
user_email: email,
code: generatedCode
}
);
return true;
} catch(error) {
console.error('EmailJS error:', error);
throw error;
}
}

async function handleCodeSubmit(event){
event.preventDefault();
const code = document.getElementById('code').value.trim();

if(Date.now() > codeExpiry){
showError('‚ùå –ö–æ–¥ –∏—Å—Ç–µ–∫. –ó–∞–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥');
return;
}

if(code !== generatedCode){
showError('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
return;
}

showLoading(true, '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...');

try {
const deviceFingerprint = getDeviceFingerprint();
const devices = currentUserData.devices || [];
if(!devices.includes(deviceFingerprint)){
devices.push(deviceFingerprint);
}

// –°–æ—Ö—Ä–∞–Ω—è–µ–º email –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ Firebase
await db.collection('users').doc(currentUsername).update({
email: currentUserData.email,
devices: devices,
lastLogin: new Date().toISOString(),
lastDevice: navigator.userAgent.includes('Mobile') ? '–ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ' : '–ö–æ–º–ø—å—é—Ç–µ—Ä'
});

await completeLogin();

} catch(error) {
console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
showError('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
showLoading(false);
}
}

async function completeLogin(){
// –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
await db.collection('logs').add({
username: currentUsername,
event: 'login_success',
details: '–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω',
timestamp: new Date().toISOString(),
userAgent: navigator.userAgent,
deviceType: navigator.userAgent.includes('Mobile') ? 'Mobile' : 'Desktop'
});

sessionStorage.setItem('user', currentUsername);
sessionStorage.setItem('userRole', currentUserData.role);
sessionStorage.setItem('userName', currentUserData.name);

showSuccess('‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...');

setTimeout(() => {
if(currentUserData.role === 'admin'){
window.location.href = 'admin.html';
} else {
window.location.href = 'app-with-demo.html';
}
}, 1000);
}

function cancelEmail(){
showForm('loginForm');
document.getElementById('info').classList.remove('show');
}

async function resendCode(){
if(!currentUserData.email){
showError('‚ùå Email –Ω–µ —É–∫–∞–∑–∞–Ω');
return;
}

showLoading(true, '–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞...');

try {
await sendVerificationCode(currentUserData.email);
showSuccess('‚úÖ –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–∞ ' + maskEmail(currentUserData.email));
document.getElementById('code').value = '';
} catch(error) {
showError('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞');
}

showLoading(false);
}

function getDeviceFingerprint(){
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
ctx.textBaseline = 'top';
ctx.font = '14px Arial';
ctx.fillText('fingerprint', 2, 2);
const canvasData = canvas.toDataURL();
const hash = canvasData.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
return Math.abs(hash).toString(36) + '-' + navigator.userAgent.length + '-' + screen.width + 'x' + screen.height;
}

function maskEmail(email){
const [name, domain] = email.split('@');
if(name.length <= 2) return email;
return name[0] + '***' + name[name.length-1] + '@' + domain;
}

// –°–∫—Ä—ã—Ç—å –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ
['username','password','email','code'].forEach(id => {
const el = document.getElementById(id);
if(el){
el.addEventListener('input', () => {
document.getElementById('error').classList.remove('show');
});
}
});
</script>

</body>
</html>
